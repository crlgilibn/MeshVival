<!-- Tawk.to Partial mit Modal Overlay f√ºr Mesh-ID -->
<style>
/* Modal Overlay */
#mesh-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
}

#mesh-modal-content {
  background: #fff;
  padding: 2rem;
  border-radius: 0.5rem;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

#mesh-modal-content label {
  display: block;        /* damit es sauber √ºber dem Input steht */
  margin-bottom: 0.5rem; /* Abstand zum Eingabefeld */
  font-size: 1rem;
  font-weight: 600;      /* etwas kr√§ftiger */
  color: #000;           /* schwarze Schrift */
}

#mesh-modal-content .mesh-hint {
  font-size: 0.875rem;      /* kleiner als normales Label */
  color: #555;              /* etwas dunkleres Grau */
  margin-top: 0.25rem;      /* Abstand zum Input */
  text-align: center;       /* optional zentrieren */
}

#mesh-modal-content input {
  width: 70%;
  padding: 0.5rem;
  margin-right: 0.5rem;
  font-size: 1rem;
  border: 1px solid #888;
  border-radius: 0.25rem;
}

#mesh-modal-content button {
  padding: 0.5rem 1rem;
  background-color: #1d4ed8;
  color: #fff;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

#mesh-modal-content button:hover {
  background-color: #2563eb;
}

/* Chat-Hinweise */
#chat-welcome, #tawk-status {
  text-align: center;
  margin-top: 1rem;
  color: #000;
}
</style>

<button id="clearMeshId">Mesh-ID l√∂schen</button>

<div id="mesh-modal" style="display:none;">
  <div id="mesh-modal-content">
    <label for="meshIdInput">Meshtastic hex-ID:</label>
    <input type="text" id="meshIdInput" placeholder=""/>
    <div class="mesh-hint">Oder Zufallszahl f√ºr Cookie</div>
    <button id="meshSubmit">OK</button>													
    <p id="meshError" style="color:red;"></p>
  </div>
</div>

<script type="text/javascript">
var Tawk_API = Tawk_API || {};
var Tawk_LoadStart = new Date();


// ---------------- Cookie Funktionen ----------------
function setCookie(name, value, days){
    var expires = "";
    if(days){
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires="+date.toUTCString();
    }
    document.cookie = name+"="+(value||"")+expires+"; path=/";
}

function getCookie(name){
    var nameEQ = name+"=";
    var ca = document.cookie.split(';');
    for(var i=0;i<ca.length;i++){
        var c = ca[i].trim();
        if(c.indexOf(nameEQ)===0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

function isValidMeshId(id) {
  return /^[a-zA-Z0-9]{1,8}$/.test(id);
}

// ---------------- Tawk laden ----------------
function initTawk(mesh){
    // Tawk Name & Email setzen, Begr√º√üung
    Tawk_API.onLoad = function(){
        Tawk_API.setAttributes({
            name: "N-" + mesh
            //email: mesh + "@meshtastic.local"
        }, function(error){
            if(!error){
                var welcome = document.getElementById("clearMeshId");
                if(welcome) welcome.innerText = "üí¨ N-" + mesh + " l√∂schen";
            }
        });

        // Agentenstatus
        // if(typeof Tawk_API.onStatusChange === "function"){
        //     Tawk_API.onStatusChange(function(status){
        //         var el = document.getElementById("tawk-status");
        //         if(el){
        //             if(status==="online") el.innerText="Chat: Online ‚úÖ";
        //             else if(status==="away") el.innerText="Chat: Abwesend ‚ö†Ô∏è";
        //             else el.innerText="Chat: Offline ‚ùå";
        //         }
        //     });
        // }
    };

    // Widget nur einmal laden
    if(!document.getElementById("tawk-script")){
        var s=document.createElement("script");
        s.id="tawk-script";
        s.type="text/javascript";
        s.async=true;
        s.src='https://embed.tawk.to/68de81da2a8b16195305984d/1j6iimgai';
        document.body.appendChild(s);
		
       // var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
       // (function(){
       // var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
       // s1.async=true;
       // s1.src='https://embed.tawk.to/68de81da2a8b16195305984d/1j6iimgai';
       // s1.charset='UTF-8';
       // s1.setAttribute('crossorigin','*');
       // s0.parentNode.insertBefore(s1,s0);
       // })();		
    }
}

function openMeshModal() {
  const modal = document.getElementById("mesh-modal");

  // 24-Bit Zufallszahl erzeugen
  const rand = Math.floor(Math.random() * 0x100000000);
  const hex = rand.toString(16).padStart(8, "0");

  const input = document.getElementById("meshIdInput");
  input.placeholder = hex;
  input.value = ""; // Benutzer darf √ºberschreiben

  modal.style.display = "flex";

  document.getElementById("meshSubmit").onclick = function() {
    const value = input.value.trim() || input.placeholder;

    if (isValidMeshId(value)) {
      setCookie("meshId", value, 365);
      modal.style.display = "none";
      initTawk(value);
    } else {
      document.getElementById("meshError").innerText =
        "Ung√ºltige ID, min. 1, max. 8 Buchstaben/Zahlen erlaubt";
    }
  };
}

document.getElementById("meshSubmit").addEventListener("click", function() {
  const input = document.getElementById("meshIdInput");
  // Wenn leer, nimm den placeholder
  const value = input.value.trim() || input.placeholder;

  if (!/^[0-9a-f]{8}$/i.test(value)) {
    document.getElementById("meshError").textContent = "Ung√ºltige Hex-ID (8 Stellen)";
    return;
  }
  
  document.getElementById("meshError").textContent = "";
  console.log("Mesh-ID gew√§hlt:", value);
  // Modal schlie√üen
  document.getElementById("mesh-modal").style.display = "none";
});

document.getElementById("clearMeshId").addEventListener("click", async function () {
  // Alle Tawk-Cookies l√∂schen
  document.cookie.split(';').forEach(function(c) {
    var name = c.split('=')[0].trim();
    if (name.startsWith('Tawk') || name.startsWith('twk_') || name === 'meshId') {
      document.cookie = name + '=; Max-Age=0; path=/;';
    }
  });

  // Alles aus localStorage und sessionStorage l√∂schen
  Object.keys(localStorage).forEach(function(k) {
    if (k.startsWith('Tawk') || k.startsWith('twk')) localStorage.removeItem(k);
  });
  
  Object.keys(sessionStorage).forEach(function(k) {
    if (k.startsWith('Tawk') || k.startsWith('twk')) sessionStorage.removeItem(k);
  });
  
  if (typeof indexedDB.databases === "function") {
    const dbs = await indexedDB.databases();
    for (const db of dbs) {
      if (db.name && (db.name.startsWith("Tawk") || db.name.startsWith("twk"))) {
	    debugger; // <-- hier h√§lt DevTools sofort an, wenn der Button gedr√ºckt wird
        indexedDB.deleteDatabase(db.name);
      }
    }
  }

  // Seite neu laden
  location.reload();
});

// Hauptlogik: Cookie pr√ºfen oder Modal √∂ffnen
(function(){
  var meshId = getCookie("meshId");

  if (meshId && isValidMeshId(meshId)) {
    // Cookie existiert ‚Üí direkt Tawk laden
    initTawk(meshId);
  } else {
    // Modal √∂ffnen
    openMeshModal();
  }
})();

</script>
