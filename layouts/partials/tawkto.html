<!-- Tawk.to Partial mit Modal Overlay f√ºr Mesh-ID -->
<style>
/* Modal Overlay */
#mesh-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
}

#mesh-modal-content {
  background: #fff;
  padding: 2rem;
  border-radius: 0.5rem;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

#mesh-modal-content label {
  display: block;        /* damit es sauber √ºber dem Input steht */
  margin-bottom: 0.5rem; /* Abstand zum Eingabefeld */
  font-size: 1rem;
  font-weight: 600;      /* etwas kr√§ftiger */
  color: #000;           /* schwarze Schrift */
}

#mesh-modal-content .mesh-hint {
  font-size: 0.875rem;      /* kleiner als normales Label */
  color: #555;              /* etwas dunkleres Grau */
  margin-top: 0.25rem;      /* Abstand zum Input */
  text-align: center;       /* optional zentrieren */
}

#mesh-modal-content input {
  width: 70%;
  padding: 0.5rem;
  margin-right: 0.5rem;
  font-size: 1rem;
  border: 1px solid #888;
  border-radius: 0.25rem;
}

#mesh-modal-content button {
  padding: 0.5rem 1rem;
  background-color: #1d4ed8;
  color: #fff;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

#mesh-modal-content button:hover {
  background-color: #2563eb;
}

/* Chat-Hinweise */
#chat-welcome, #tawk-status {
  text-align: center;
  margin-top: 1rem;
  color: #000;
}
</style>

<button id="clearMeshId">Mesh-ID l√∂schen</button>

<div id="mesh-modal" style="display:none;">
  <div id="mesh-modal-content">
    <label for="meshIdInput">Meshtastic hex-ID:</label>
    <input type="text" id="meshIdInput" maxlength="8" placeholder=""/>
    <div class="mesh-hint">Oder Zufallszahl f√ºr Cookie</div>
    <button id="meshSubmit">OK</button>													
    <p id="meshError" style="color:red;"></p>
  </div>
</div>

<script type="text/javascript">
/* Hilfsfunktionen */
function setCookie(name, value, days) {
  var expires = "";
  if (days) {
    var d = new Date();
    d.setTime(d.getTime() + days*24*60*60*1000);
    expires = "; expires=" + d.toUTCString();
  }
  document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
}
function getCookie(name) {
  var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : null;
}
function deleteCookie(name) {
  document.cookie = name + "=; Max-Age=0; path=/";
}

/* Fallback-Validator, nur falls isValidMeshId nicht vorhanden ist */
if (typeof isValidMeshId !== 'function') {
  function isValidMeshId(x) {
    return /^[A-Za-z0-9]{1,8}$/.test(String(x));
  }
}

/* Aktualisiert den "clearMeshId"-Button und setzt den L√∂sch-Handler */
function updateClearButton(mesh) {
  const btn = document.getElementById("clearMeshId");
  if (!btn) return;
  btn.innerText = "üí¨ N-" + mesh + " l√∂schen";
  btn.dataset.mesh = mesh;

  // Ersetze vorhandenen Handler (keine Mehrfach-Handler)
  btn.onclick = async function () {
    // Optional: best√§tigung
    if (!confirm("Mesh-ID N-" + mesh + " wirklich l√∂schen und Chat zur√ºcksetzen?")) return;

    // L√∂schen (await f√ºr caches)
    if (window.caches) {
      try {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      } catch (e) {
        console.warn("Caches l√∂schen fehlgeschlagen:", e);
      }
    }

    // Clear storages
    try { localStorage.clear(); } catch (e) {}
    try { sessionStorage.clear(); } catch (e) {}

    // Cookies l√∂schen (alle lokalen Cookies)
    document.cookie.split(';').forEach(c => {
      const name = c.split('=')[0].trim();
      document.cookie = name + '=; Max-Age=0; path=/;';
    });

    // Mesh-Cookie explizit l√∂schen
    deleteCookie('meshId');
	
    // Tawk-API beenden, falls geladen
    if (window.Tawk_API && Tawk_API.endChat) {
      try { Tawk_API.endChat(); } catch (e) {}
    }

    // Tawk-Elemente entfernen (Script + iframe)
    document.querySelectorAll("iframe[src*='tawk.to']").forEach(f => f.remove());
    const s = document.getElementById("tawk-script");
    if (s) s.remove();

    // Versuche globale API zu entfernen
    try { delete window.Tawk_API; } catch(e) {}
    try { delete window.Tawk_LoadStart; } catch(e) {}

    // Seite neu laden (erst nachdem obige async-Arbeiten abgeschlossen sind)
    location.reload();
  };
}

/* initTawk: robustere Variante, die auch dann arbeitet, wenn das Script schon geladen ist */
function initTawk(mesh) {
  // Sorge daf√ºr, dass Tawk_API existiert und Tawk_LoadStart gesetzt ist (√§hnlich original)
  window.Tawk_API = window.Tawk_API || {};
  window.Tawk_LoadStart = window.Tawk_LoadStart || new Date();

  // onLoad handler (wird entweder vom Widget aufgerufen oder wir rufen setAttributes direkt auf)
  const doSetAttrs = function() {
    if (window.Tawk_API && typeof window.Tawk_API.setAttributes === 'function') {
      window.Tawk_API.setAttributes({
        name: "N-" + mesh
        // email: mesh + "@meshtastic.local"
      }, function(error) {
        if (!error) {
          updateClearButton(mesh);
        }
      });
    } else {
      // Falls noch nicht verf√ºgbar: trotzdem Button aktualisieren
      updateClearButton(mesh);
    }
  };

  // Registrieren des onLoad-Handlers so, dass das Tawk-Widget ihn aufruft
  try {
    // Manche Implementationen benutzen onLoad property
    window.Tawk_API.onLoad = doSetAttrs;
  } catch (e) {}

  // Falls bereits verf√ºgbar, sofort setzen
  if (window.Tawk_API && typeof window.Tawk_API.setAttributes === 'function') {
    doSetAttrs();
  }

  // Widget nur einmal anf√ºgen
  if (!document.getElementById("tawk-script")) {
    var s = document.createElement("script");
    s.id = "tawk-script";
    s.type = "text/javascript";
    s.async = true;
    s.charset = 'UTF-8';
    s.setAttribute('crossorigin', '*');
    s.src = 'https://embed.tawk.to/68de81da2a8b16195305984d/1j6iimgai';
    document.body.appendChild(s);
  }
}

/* Modal √∂ffnen und Mesh-ID abfragen */
function openMeshModal() {
  const modal = document.getElementById("mesh-modal");
  const input = document.getElementById("meshIdInput");
  const submit = document.getElementById("meshSubmit");
  const errorEl = document.getElementById("meshError");

  if (!modal || !input || !submit) {
    console.warn("Modal-Elemente fehlen.");
    return;
  }

  // Zufall (8 hex Zeichen)
  const rand = Math.floor(Math.random() * 0x100000000);
  const hex = rand.toString(16).padStart(8, "0");
  input.placeholder = hex;
  input.value = "";

  modal.style.display = "flex";
  errorEl && (errorEl.innerText = "");

  // √úberschreibenden Handler setzen (ersetzt vorherige)
  submit.onclick = function () {
    const value = (input.value || input.placeholder || "").trim();
    if (!isValidMeshId(value)) {
      if (errorEl) errorEl.innerText = "Ung√ºltige ID, min. 1, max. 8 Buchstaben/Zahlen erlaubt";
      return;
    }

    // Save + init + Button update
    setCookie("meshId", value, 365);
    modal.style.display = "none";
    initTawk(value);
    updateClearButton(value);
  };
}

/* Hauptlogik */
document.addEventListener("DOMContentLoaded", function () {
  const mesh = getCookie("meshId");
  if (mesh && isValidMeshId(mesh)) {
    initTawk(mesh);
    updateClearButton(mesh);
  } else {
    openMeshModal();
  }

  // Falls es einen statischen clear button ohne Daten gibt, stelle sicher dass er einen Handler hat
  // (wird √ºberschrieben, wenn updateClearButton sp√§ter aufgerufen wird)
  const staticClear = document.getElementById("clearMeshId");
  if (staticClear && !staticClear.onclick) {
    staticClear.onclick = function () {
      // fallback: wenn kein mesh gesetzt, l√∂sche trotzdem
      if (confirm("Alle lokalen Daten l√∂schen?")) {
        if (window.caches) {
          caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
        }
        try { localStorage.clear(); } catch(e) {}
        try { sessionStorage.clear(); } catch(e) {}
        document.querySelectorAll("iframe[src*='tawk.to']").forEach(f => f.remove());
        const s = document.getElementById("tawk-script"); if (s) s.remove();
        deleteCookie('meshId');
        location.reload();
      }
    };
  }
});
</script>

